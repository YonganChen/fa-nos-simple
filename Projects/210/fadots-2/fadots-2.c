/*
 * Main.c
 *
 *  Created on: 2012-12-12
 *      Author: cya
 */

#include <stdint.h>
#include "../../Components/uart/uart.h"
#include "../../Components/gpio/gpio.h"
#include "../../Components/xprintf/xprintf.h"

#define DELAY_1S_VAL    (0xfffff)
#define DELAY_1MS_VAL   (0x418)
#define DELAY_1US_VAL   (0x01)

/*
 *  delay some time
 */
void delay(volatile uint32_t count)
{
    for(;count>0;count--){
    }
}


// data_pin: GPH0_3, sclk_pin: GPH0_1, rclk_pin: GPH0_2

//-----------------------------------------------------------------------
 void init_gpio()
 {
 	GPH0CON = 0x00001111;                   // set GPH0_0~GPH0_3 to output
	GPH0DAT = 0x0f;                         // default high
 }

//------------------------------------------------------------------------
 void set_data( uint32_t data )
 {
 	if ( data==0 ) {
 		GPH0DAT &= ~(0x08); 
 	}
 	else {
 		GPH0DAT |= 0x08;
 	}
 }


//------------------------------------------------------------------------
  void set_sclk( uint32_t sclk )
 {
 	if ( sclk==0 ) {
 		GPH0DAT &= ~(0x02); 
 	}
 	else {
 		GPH0DAT |= 0x02;
 	}
 }

//-------------------------------------------------------------------------
  void set_rclk( uint32_t rclk )
 {
 	if ( rclk==0 ) {
 		GPH0DAT &= ~(0x04); 
 	}
 	else {
 		GPH0DAT |= 0x04;
 	}
 }

unsigned char Max7219CharMap[38][9]={
        {'0', 0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//0
        {'1', 0x10,0x18,0x14,0x10,0x10,0x10,0x10,0x10},//1
        {'2', 0x7E,0x2,0x2,0x7E,0x40,0x40,0x40,0x7E},//2
        {'3', 0x3E,0x2,0x2,0x3E,0x2,0x2,0x3E,0x0},//3
        {'4', 0x8,0x18,0x28,0x48,0xFE,0x8,0x8,0x8},//4
        {'5', 0x3C,0x20,0x20,0x3C,0x4,0x4,0x3C,0x0},//5
        {'6', 0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C,0x0},//6
        {'7', 0x3E,0x22,0x4,0x8,0x8,0x8,0x8,0x8},//7
        {'8', 0x0,0x3E,0x22,0x22,0x3E,0x22,0x22,0x3E},//8
        {'9', 0x3E,0x22,0x22,0x3E,0x2,0x2,0x2,0x3E},//9
        {'A', 0x8,0x14,0x22,0x3E,0x22,0x22,0x22,0x22},//A
        {'B', 0x3C,0x22,0x22,0x3E,0x22,0x22,0x3C,0x0},//B
        {'C', 0x3C,0x40,0x40,0x40,0x40,0x40,0x3C,0x0},//C
        {'D', 0x7C,0x42,0x42,0x42,0x42,0x42,0x7C,0x0},//D
        {'E', 0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C},//E
        {'F', 0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},//F
        {'G', 0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C},//G
        {'H', 0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44},//H
        {'I', 0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C},//I
        {'J', 0x3C,0x8,0x8,0x8,0x8,0x8,0x48,0x30},//J
        {'K', 0x0,0x24,0x28,0x30,0x20,0x30,0x28,0x24},//K
        {'L', 0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C},//L
        {'M', 0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81},//M
        {'N', 0x0,0x42,0x62,0x52,0x4A,0x46,0x42,0x0},//N
        {'O', 0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//O
        {'P', 0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20},//P
        {'Q', 0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D},//Q
        {'R', 0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21},//R
        {'S', 0x0,0x1E,0x20,0x20,0x3E,0x2,0x2,0x3C},//S
        {'T', 0x0,0x3E,0x8,0x8,0x8,0x8,0x8,0x8},//T
        {'U', 0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1C},//U
        {'V', 0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},//V
        {'W', 0x0,0x49,0x49,0x49,0x49,0x2A,0x1C,0x0},//W
        {'X', 0x0,0x41,0x22,0x14,0x8,0x14,0x22,0x41},//X
        {'Y', 0x41,0x22,0x14,0x8,0x8,0x8,0x8,0x8},//Y
        {'Z', 0x0,0x7F,0x2,0x4,0x8,0x10,0x20,0x7F},//Z
        {'0', 0x8,0x7F,0x49,0x49,0x7F,0x8,0x8,0x8}, //?
        {'0', 0xFE,0xBA,0x92,0xBA,0x92,0x9A,0xBA,0xFE},//?
};



//--------------------------------------------------------------------------
void LEDOutput(uint32_t c)           
{   
    unsigned char i;
    for (i=16; i>=1; i--)
    {
        if (c&0x8000) {
            set_data(1);
        } else { 
            set_data(0);
        }
        c<<=1;
        set_sclk(0);
        delay(DELAY_1US_VAL);
        set_sclk(1);
        delay(DELAY_1US_VAL);
    }

    set_rclk(0);
    delay(DELAY_1US_VAL);
    set_rclk(1);
    delay(DELAY_1US_VAL);
}

//----------------------------------------------------------------------------
static int MAX7219WriteByte(int devFD, unsigned char address, unsigned char data)
{
    uint8_t i;
    uint32_t x=0x0000;

    x = (0x000f & address) << 8;
    x |= (0x00ff & data);
    LEDOutput(x);
    return 0;
}

//------------------------------------------------------------------------------
int MAX7219DispChar(int devFD, unsigned char c)
{
    int i = 0;
    int index = -1;
    int address,data;
    for (i=0; i<38; i++) {
        if (Max7219CharMap[i][0] == c) {
            index = i;
            break;
        }
    }

    for (i=0; i<8; i++)
    {   
        address = i + 1;
        data = Max7219CharMap[index][address];
        // printf("addr=%d data=%x\n",address, data);
        MAX7219WriteByte(devFD, address, data);

    }
    return 0;
}




//-------------------------------------------------------------------------------
int MAX7219Init()
{
    // LEDOutput( 0x0900 );   // No decode 
    // LEDOutput( 0x0A06 );   // setting Intensity
    // LEDOutput( 0x0B07 );   // Display column 0 1 2 3 4 5 6 7
    // LEDOutput( 0x0C01 );   // Normal Operation
    // LEDOutput( 0x0F00 );   // Normal Operation

    MAX7219WriteByte(0, 0x09, 0x00); 
    MAX7219WriteByte(0, 0x0a, 0x03);  
    MAX7219WriteByte(0, 0x0b, 0x07);  
    MAX7219WriteByte(0, 0x0c, 0x01);   
    MAX7219WriteByte(0, 0x0f, 0x00); 

    return 0;
}


//---------------------------------------------------------------------------------
int MAX7219CleanScreen ()
{

    int i,address, data;    
    data = 0;
    for (i=0; i<8; i++)
    {   
        address = i + 1;
        MAX7219WriteByte(0, address, data);
        
    }
    return 0;
}




//-------------------------------------------------------------------------
 void start(void) __attribute__((section(".start")));
 void start() 
 {
	uint32_t temp;
	uint8_t getstr[20];

	uart0_init(115200);

	xdev_out(uart0_putc);
	xdev_in(uart0_getc);

	xprintf("FA210 Tester v1\n");

	init_gpio();
  MAX7219Init();
  MAX7219CleanScreen();

	while(1){
     MAX7219DispChar(0,'A');
     delay(DELAY_1S_VAL);
     MAX7219DispChar(0,'B');
     delay(DELAY_1S_VAL);
     MAX7219DispChar(0,'C');
     delay(DELAY_1S_VAL);
     MAX7219DispChar(0,'D');
     delay(DELAY_1S_VAL);
	 }
 }
